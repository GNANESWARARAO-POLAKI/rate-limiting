<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Limiting Test - Contact Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .rate-limit-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .stats-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .stats-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stats-label {
            color: #666;
        }

        .stats-value {
            color: #333;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="container" id="mainContainer">
        <!-- This will be hidden if rate limited -->
        <div id="normalContent">
            <h1>🚀 Contact Form</h1>
            <p class="subtitle">Testing IP-based Rate Limiting</p>

            <div class="rate-limit-info">
                <strong>Rate Limit:</strong> 10 requests per minute per IP address.<br>
                Try refreshing the page multiple times quickly to test the rate limiting!
            </div>

            <form id="contactForm">
                <div class="form-group">
                    <label for="name">Your Name</label>
                    <input type="text" id="name" name="name" placeholder="Enter your full name" required>
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                </div>

                <div class="form-group">
                    <label for="subject">Subject</label>
                    <input type="text" id="subject" name="subject" placeholder="What's this about?" required>
                </div>

                <div class="form-group">
                    <label for="message">Message</label>
                    <textarea id="message" name="message" placeholder="Tell us what's on your mind..."
                        required></textarea>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn-primary" id="submitBtn">
                        📩 Send Message
                    </button>
                    <button type="button" class="btn-secondary" onclick="testRateLimit()">
                        🧪 Quick Test (12x)
                    </button>
                </div>

                <div class="btn-container" style="margin-top: 10px;">
                    <button type="button" class="btn-secondary" onclick="resetStats()" style="flex: 1;">
                        🔄 Reset Stats
                    </button>
                    <button type="button" class="btn-secondary" onclick="testRateLimitSameEndpoint()" style="flex: 1;">
                        ⚡ Rapid Test (15x)
                    </button>
                </div>
            </form>

            <div id="status" class="status"></div>

            <div class="stats-box">
                <div class="stats-title">📊 Request Statistics</div>
                <div class="stats-item">
                    <span class="stats-label">Total Requests:</span>
                    <span class="stats-value" id="totalRequests">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Successful:</span>
                    <span class="stats-value" id="successCount">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Rate Limited:</span>
                    <span class="stats-value" id="rateLimitedCount">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Your IP:</span>
                    <span class="stats-value" id="userIP">Detecting...</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Last Check:</span>
                    <span class="stats-value" id="lastCheck">Not tested</span>
                </div>
            </div>

            <div class="btn-container" style="margin-top: 10px;">
                <button type="button" class="btn-secondary" onclick="checkCurrentStatus()" style="width: 100%;">
                    📊 Check Current Rate Limit Status
                </button>
            </div>
        </div>

        <!-- Rate Limited Content (hidden by default) -->
        <div id="rateLimitedContent" style="display: none;">
            <div style="text-align: center; padding: 40px;">
                <h1 style="color: #721c24; margin-bottom: 20px;">⛔ Rate Limit Exceeded</h1>
                <div class="rate-limit-info" style="background: #f8d7da; color: #721c24; border-color: #f5c6cb;">
                    <p style="margin-bottom: 15px;"><strong>Too Many Requests!</strong></p>
                    <p style="margin-bottom: 15px;">You have exceeded the rate limit of <strong>10 requests per
                            minute</strong> for this website.</p>
                    <p style="margin-bottom: 15px;">Your IP: <span id="blockedIP">Loading...</span></p>
                    <p style="margin-bottom: 20px;">Please wait <strong><span id="retryTime">--</span> seconds</strong>
                        before trying again.</p>

                    <div style="margin-top: 20px;">
                        <button onclick="retryAccess()" class="btn-secondary" style="width: 200px; margin: 10px;">
                            🔄 Try Again
                        </button>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            <p>This demonstrates IP-based rate limiting protection.</p>
                            <p>In a real website, this would prevent abuse and server overload.</p>
                        </div>
                    </div>
                </div>

                <div class="stats-box" style="margin-top: 20px;">
                    <div class="stats-title">📊 Access Statistics</div>
                    <div class="stats-item">
                        <span class="stats-label">Page Load Attempts:</span>
                        <span class="stats-value" id="totalRequests2">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Successful Loads:</span>
                        <span class="stats-value" id="successCount2">0</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Blocked Loads:</span>
                        <span class="stats-value" id="rateLimitedCount2">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Content -->
        <div id="loadingContent" style="text-align: center; padding: 40px;">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <p>Checking rate limit...</p>
        </div>
    </div>

    <script>
        // Configuration - Dynamic host detection
        const getCurrentHost = () => {
            // Get current page host and use it for API calls
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            return `${protocol}//${hostname}`;
        };

        const RATE_LIMIT_API = `${getCurrentHost()}:8000/check-limit-ip`;
        const CONTACT_API = `${getCurrentHost()}:8000/contact`; // This would be your actual contact endpoint
        const API_KEY = 'rl_sjTMNROLZd1YaMHvq1QL6k7374Lj0ow8xRCT19XcWss'; // Replace with your actual API key

        // Statistics
        let totalRequests = 0;
        let successCount = 0;
        let rateLimitedCount = 0;

        // Get user's IP address from our own rate limiting service
        async function getUserIP() {
            try {
                // Make a simple rate limit check to get our IP from our own service
                const result = await checkRateLimit('/ip-check');
                if (result.client_ip && result.client_ip !== 'unknown') {
                    document.getElementById('userIP').textContent = result.client_ip;
                } else {
                    document.getElementById('userIP').textContent = 'Detected from rate limit service';
                }
            } catch (error) {
                document.getElementById('userIP').textContent = 'Will be detected on first request';
            }
        }

        // Check rate limit before making the actual request
        async function checkRateLimit(endpoint = '/contact') {
            try {
                const response = await fetch(RATE_LIMIT_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: API_KEY,
                        endpoint: endpoint
                    })
                });

                const result = await response.json();

                // Update the displayed IP from our own service response
                if (result.client_ip && result.client_ip !== 'unknown') {
                    document.getElementById('userIP').textContent = result.client_ip;
                }

                // The API returns 200 OK for both success and rate-limited responses
                // Check the 'allowed' field to determine if rate limited
                if (!result.allowed) {
                    // Rate limit exceeded
                    return {
                        allowed: false,
                        error: result.message || 'Rate limit exceeded',
                        retry_after: result.retry_after || 60,
                        remaining_quota: result.remaining_quota || 0,
                        client_ip: result.client_ip || 'unknown',
                        identifier: result.identifier || 'unknown'
                    };
                }

                // Request allowed
                return {
                    allowed: true,
                    remaining_quota: result.remaining_quota || 0,
                    retry_after: result.retry_after || 0,
                    message: result.message || 'Request allowed',
                    client_ip: result.client_ip || 'unknown',
                    identifier: result.identifier || 'unknown',
                    endpoint: result.endpoint || endpoint
                };

            } catch (error) {
                console.error('Rate limit check failed:', error);
                // Fail-open: allow the request if rate limit service is down
                return {
                    allowed: true,
                    error: 'Rate limit service unavailable',
                    remaining_quota: 'unknown'
                };
            }
        }

        // Simulate sending contact form
        async function sendContactForm(formData) {
            // In a real application, this would send data to your backend
            // For demo purposes, we'll just simulate success
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        success: true,
                        message: 'Contact form submitted successfully!'
                    });
                }, 500);
            });
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';

            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Check if page access is allowed (rate limit check on page load)
        async function checkPageAccess() {
            try {
                // Show loading content
                document.getElementById('loadingContent').style.display = 'block';
                document.getElementById('normalContent').style.display = 'none';
                document.getElementById('rateLimitedContent').style.display = 'none';

                totalRequests++;
                updateStats();

                // Check rate limit for page access
                const result = await checkRateLimit('/page-access');

                // Update IP display from the response
                if (result.client_ip && result.client_ip !== 'unknown') {
                    const userIPElement = document.getElementById('userIP');
                    if (userIPElement) {
                        userIPElement.textContent = result.client_ip;
                    }
                }

                if (result.allowed) {
                    // Access allowed - show normal content
                    successCount++;
                    updateStats();

                    document.getElementById('loadingContent').style.display = 'none';
                    document.getElementById('normalContent').style.display = 'block';
                    document.getElementById('rateLimitedContent').style.display = 'none';

                    // Attach form handler now that normal content is shown
                    const contactForm = document.getElementById('contactForm');
                    if (contactForm && !contactForm.hasAttribute('data-handler-attached')) {
                        contactForm.addEventListener('submit', handleFormSubmit);
                        contactForm.setAttribute('data-handler-attached', 'true');
                    }

                    showStatus('🎯 Page loaded successfully! Rate limit check passed.', 'success');
                } else {
                    // Rate limited - show blocked content
                    rateLimitedCount++;
                    updateStats();

                    document.getElementById('loadingContent').style.display = 'none';
                    document.getElementById('normalContent').style.display = 'none';
                    document.getElementById('rateLimitedContent').style.display = 'block';

                    // Update blocked page info
                    document.getElementById('blockedIP').textContent = result.client_ip || 'Unknown';
                    document.getElementById('retryTime').textContent = result.retry_after || 60;

                    // Update stats in blocked view too
                    document.getElementById('totalRequests2').textContent = totalRequests;
                    document.getElementById('successCount2').textContent = successCount;
                    document.getElementById('rateLimitedCount2').textContent = rateLimitedCount;

                    // Start countdown timer
                    startRetryCountdown(result.retry_after || 60);
                }

            } catch (error) {
                console.error('Page access check failed:', error);
                // On error, show normal content (fail-open)
                document.getElementById('loadingContent').style.display = 'none';
                document.getElementById('normalContent').style.display = 'block';
                document.getElementById('rateLimitedContent').style.display = 'none';

                // Attach form handler in error case too
                const contactForm = document.getElementById('contactForm');
                if (contactForm && !contactForm.hasAttribute('data-handler-attached')) {
                    contactForm.addEventListener('submit', handleFormSubmit);
                    contactForm.setAttribute('data-handler-attached', 'true');
                }

                showStatus('⚠️ Rate limit service unavailable. Access granted.', 'info');
            }
        }

        // Start countdown for retry
        function startRetryCountdown(seconds) {
            const retryElement = document.getElementById('retryTime');
            let remaining = seconds;

            const countdown = setInterval(() => {
                retryElement.textContent = remaining;

                if (remaining <= 0) {
                    clearInterval(countdown);
                    retryElement.textContent = '0';
                }
                remaining--;
            }, 1000);
        }

        // Retry access function
        async function retryAccess() {
            await checkPageAccess();
        }

        // Update both sets of statistics
        function updateStats() {
            // Main stats
            document.getElementById('totalRequests').textContent = totalRequests;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('rateLimitedCount').textContent = rateLimitedCount;

            // Blocked page stats
            const totalRequests2 = document.getElementById('totalRequests2');
            const successCount2 = document.getElementById('successCount2');
            const rateLimitedCount2 = document.getElementById('rateLimitedCount2');

            if (totalRequests2) totalRequests2.textContent = totalRequests;
            if (successCount2) successCount2.textContent = successCount;
            if (rateLimitedCount2) rateLimitedCount2.textContent = rateLimitedCount;
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            // Show loading state
            submitBtn.innerHTML = '<span class="spinner"></span>Checking Rate Limit...';
            submitBtn.disabled = true;

            try {
                totalRequests++;
                updateStats();

                // Step 1: Check rate limit
                const rateLimitResult = await checkRateLimit('/contact');

                if (!rateLimitResult.allowed) {
                    // Rate limit exceeded
                    rateLimitedCount++;
                    updateStats();

                    showStatus(
                        `⛔ ${rateLimitResult.error}. Please try again in ${rateLimitResult.retry_after} seconds.`,
                        'error'
                    );
                    return;
                }

                // Step 2: Rate limit passed, process the form
                submitBtn.innerHTML = '<span class="spinner"></span>Sending Message...';

                const formData = new FormData(event.target);
                const contactResult = await sendContactForm(formData);

                if (contactResult.success) {
                    successCount++;
                    updateStats();

                    showStatus(
                        `✅ ${contactResult.message}`,
                        'success'
                    );

                    // Clear form
                    event.target.reset();
                } else {
                    showStatus(
                        `❌ Failed to send message: ${contactResult.error}`,
                        'error'
                    );
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus(
                    `❌ An error occurred: ${error.message}`,
                    'error'
                );
            } finally {
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Test rate limiting by making multiple requests quickly
        async function testRateLimit() {
            showStatus('🧪 Testing rate limit with 12 quick requests to /contact endpoint...', 'info');

            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

            for (let i = 1; i <= 12; i++) {
                try {
                    totalRequests++;
                    updateStats();

                    // Use the same endpoint as the contact form to test the actual limit
                    const result = await checkRateLimit('/contact');

                    if (result.allowed) {
                        successCount++;
                        console.log(`✅ Request ${i}: Allowed (${result.remaining_quota} remaining)`);
                    } else {
                        rateLimitedCount++;
                        console.log(`⛔ Request ${i}: Rate limited - ${result.error}`);
                        showStatus(
                            `⛔ Rate limit hit on request ${i}/12! ${result.error}. Retry in ${result.retry_after}s`,
                            'error'
                        );
                        break;
                    }

                    updateStats();
                    await delay(100); // Small delay between requests

                } catch (error) {
                    console.error(`❌ Request ${i} failed:`, error);
                }
            }

            if (rateLimitedCount === 0) {
                showStatus('⚠️ All 12 test requests were allowed! Rate limit might be higher or reset.', 'info');
            }
        }

        // Test with rapid requests to same endpoint (no delay)
        async function testRateLimitSameEndpoint() {
            showStatus('⚡ Rapid fire test - 15 requests with minimal delay...', 'info');

            const startTime = Date.now();
            let rateLimitHit = false;

            for (let i = 1; i <= 15; i++) {
                try {
                    totalRequests++;
                    updateStats();

                    const result = await checkRateLimit('/contact');

                    if (result.allowed) {
                        successCount++;
                        console.log(`✅ Request ${i}: Allowed (${result.remaining_quota} remaining) - ${Date.now() - startTime}ms`);
                    } else {
                        rateLimitedCount++;
                        rateLimitHit = true;
                        console.log(`⛔ Request ${i}: Rate limited - ${result.error} - ${Date.now() - startTime}ms`);
                        showStatus(
                            `🎯 SUCCESS! Rate limit hit on request ${i}/15 after ${Date.now() - startTime}ms. ${result.error}`,
                            'error'
                        );
                        break;
                    }

                    updateStats();

                } catch (error) {
                    console.error(`❌ Request ${i} failed:`, error);
                }
            }

            if (!rateLimitHit) {
                showStatus('⚠️ No rate limit hit in 15 requests. Check if limits are set correctly.', 'info');
            }
        }

        // Reset statistics
        function resetStats() {
            totalRequests = 0;
            successCount = 0;
            rateLimitedCount = 0;
            updateStats();
            showStatus('🔄 Statistics reset. Ready for new test!', 'info');
        }

        // Check current rate limit status
        async function checkCurrentStatus() {
            try {
                showStatus('📊 Checking current rate limit status...', 'info');

                const result = await checkRateLimit('/contact');

                const statusText = result.allowed ?
                    `✅ ALLOWED - ${result.remaining_quota} requests remaining` :
                    `⛔ BLOCKED - Retry in ${result.retry_after} seconds`;

                document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString();

                showStatus(
                    `📊 ${statusText} | IP: ${result.client_ip || 'unknown'}`,
                    result.allowed ? 'success' : 'error'
                );

                // If we made this check, count it
                totalRequests++;
                if (result.allowed) {
                    successCount++;
                } else {
                    rateLimitedCount++;
                }
                updateStats();

            } catch (error) {
                console.error('Status check failed:', error);
                showStatus('❌ Failed to check rate limit status', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Automatically check page access on load
            checkPageAccess();
        });
    </script>
</body>

</html>